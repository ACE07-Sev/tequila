<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tequila.quantumchemistry.psi4_interface &#8212; tequila 0.0.3 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          Tequila</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../.././tequila_presentation.html">Overview</a></li>
                <li><a href="../../.././README.html">Installation</a></li>
                <li><a href="../../.././package/index.html">API</a></li>
                <li><a href="https://github.com/aspuru-guzik-group/tequila">GitHub</a></li>
                <li><a href="../../.././tutorials.html">Tutorials</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Tequila</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#quantum-backends">Quantum Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#quantumchemistry">QuantumChemistry:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#getting-started">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#dependencies">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#documentation">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#troubleshooting">Troubleshooting</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../package/index.html">Tequila Library Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tequila.quantumchemistry.psi4_interface</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">tequila</span> <span class="kn">import</span> <span class="n">TequilaException</span>
<span class="kn">from</span> <span class="nn">openfermion</span> <span class="kn">import</span> <span class="n">MolecularData</span>

<span class="kn">from</span> <span class="nn">tequila.circuit</span> <span class="kn">import</span> <span class="n">QCircuit</span>
<span class="kn">from</span> <span class="nn">tequila.objective.objective</span> <span class="kn">import</span> <span class="n">Variables</span>
<span class="kn">from</span> <span class="nn">tequila.quantumchemistry.qc_base</span> <span class="kn">import</span> <span class="n">ParametersQC</span><span class="p">,</span> <span class="n">QuantumChemistryBase</span><span class="p">,</span>\
    <span class="n">ClosedShellAmplitudes</span><span class="p">,</span> <span class="n">Amplitudes</span><span class="p">,</span> <span class="n">NBodyTensor</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">psi4</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>


<span class="k">class</span> <span class="nc">TequilaPsi4Exception</span><span class="p">(</span><span class="n">TequilaException</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">OpenVQEEPySCFException</span><span class="p">(</span><span class="n">TequilaException</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Psi4Results</span><span class="p">:</span>
    <span class="n">variables</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># psi4 variables dictionary, storing all computed values</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># psi4 output file</span>
    <span class="n">wfn</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="p">,</span> <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CCWavefunction</span><span class="p">,</span> <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CIWavefunction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># psi4 wavefunction</span>
    <span class="n">mol</span><span class="p">:</span> <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Molecule</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="QuantumChemistryPsi4"><a class="viewcode-back" href="../../../package/quantumchemistry/tequila.quantumchemistry.QuantumChemistryPsi4.html#tequila.quantumchemistry.QuantumChemistryPsi4">[docs]</a><span class="k">class</span> <span class="nc">QuantumChemistryPsi4</span><span class="p">(</span><span class="n">QuantumChemistryBase</span><span class="p">):</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">OrbitalData</span><span class="p">:</span>
        <span class="n">irrep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">idx_irrep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">idx_total</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}{}</span><span class="s2"> energy = </span><span class="si">{:+2.6f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_total</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_irrep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">irrep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_psi4_active_space_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_orbitals</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Small helper function</span>
<span class="sd">        Internal use only</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        active_orbitals: dictionary :</span>
<span class="sd">            dictionary with irreps as keys and a list of integers as values</span>
<span class="sd">            i.e. occ = {&quot;A1&quot;:[0,1], &quot;A2&quot;:[0]}</span>
<span class="sd">            means the occupied active space is made up of spatial orbitals</span>
<span class="sd">            0A1, 1A1 and 0A2</span>
<span class="sd">            as list: Give a list of spatial orbital indices</span>
<span class="sd">            i.e. occ = [0,1,3] means that spatial orbital 0, 1 and 3 are used</span>
<span class="sd">        reference: (Default value=None)</span>
<span class="sd">            List of orbitals which form the reference</span>
<span class="sd">            Can be given in the same format as active_orbitals</span>
<span class="sd">            If given as None then the first N_electron/2 orbitals are taken</span>
<span class="sd">            and the corresponding active orbitals are removed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dataclass with active indices and reference indices (in spatial notation)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">active_orbitals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="nd">@dataclass</span>
        <span class="k">class</span> <span class="nc">ActiveSpaceData</span><span class="p">:</span>
            <span class="n">active_orbitals</span><span class="p">:</span> <span class="nb">list</span>  <span class="c1"># active orbitals (spatial, c1)</span>
            <span class="n">reference_orbitals</span><span class="p">:</span> <span class="nb">list</span>  <span class="c1"># reference orbitals (spatial, c1)</span>
            <span class="n">frozen_docc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># frozen reference orbitals grouped by irrep (psi4 option, if None then the active space can not be represented by psi4)</span>
            <span class="n">frozen_uocc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># frozen virtual orbtials grouped by irrep (psi4 option, if None then the active space can not be represented by psi4)</span>

            <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;Active Space Data:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value:15}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;active_orbitals&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_orbitals</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value:15}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;reference_orbitals&quot;</span><span class="p">,</span>
                                                            <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_orbitals</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value:15}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;frozen_docc&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frozen_docc</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value:15}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;frozen_uocc&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frozen_uocc</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">frozen_reference_orbitals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_orbitals</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_orbitals</span><span class="p">]</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">psi4_representable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen_docc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen_uocc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">active_reference_orbitals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_orbitals</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_orbitals</span><span class="p">]</span>

        <span class="c1"># transform irrep notation to absolute ints</span>
        <span class="n">active_idx</span> <span class="o">=</span> <span class="n">active_orbitals</span>
        <span class="n">ref_idx</span> <span class="o">=</span> <span class="n">reference</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">active_orbitals</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">active_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">frozen_uocc</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">active_orbitals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">active_idx</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitals_by_irrep</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">idx_total</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">active_orbitals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">active_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_orbitals</span><span class="p">)]</span>

        <span class="n">standard_ref</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_electrons</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">ref_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">reference</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">orbitals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitals_by_irrep</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                <span class="n">ref_idx</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">idx_total</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">orbitals</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_electrons</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ref_idx</span> <span class="o">=</span> <span class="n">standard_ref</span>

        <span class="c1"># determine if the active space can be represented by psi4</span>
        <span class="c1"># reference needs to be the scf reference</span>
        <span class="c1"># all frozen orbitals need to be without gaps since we can not freeze individual orbitals</span>
        <span class="n">frozen_docc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ref_idx</span> <span class="o">==</span> <span class="n">standard_ref</span><span class="p">:</span>
            <span class="n">frozen_docc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nirrep</span>
            <span class="n">frozen_docc_all</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">standard_ref</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">idx_total</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">irrep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps</span><span class="p">):</span>
                <span class="n">sorted_array</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">idx_irrep</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">frozen_docc_all</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">irrep</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">irrep</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
                <span class="n">frozen_docc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_array</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sorted_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sorted_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">frozen_docc</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;active space not CAS type: frozen_docc of </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">irrep</span><span class="p">),</span> <span class="n">sorted_array</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="c1"># and the same for the unoccupied ones</span>
        <span class="n">frozen_uocc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">frozen_docc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frozen_uocc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nirrep</span>
            <span class="n">frozen_uocc_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitals</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">idx_total</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_idx</span> <span class="o">+</span> <span class="n">ref_idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">irrep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">irrep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitals_by_irrep</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">sorted_array</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">idx_irrep</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">frozen_uocc_all</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">irrep</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">irrep</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
                <span class="n">frozen_uocc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_array</span><span class="p">)</span>
                <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitals_by_irrep</span><span class="p">[</span><span class="n">irrep</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">sorted_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">last</span><span class="o">.</span><span class="n">idx_irrep</span> <span class="ow">or</span> <span class="n">sorted_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sorted_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">sorted_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">frozen_uocc</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">ActiveSpaceData</span><span class="p">(</span><span class="n">active_orbitals</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">active_idx</span><span class="p">),</span>
                               <span class="n">reference_orbitals</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ref_idx</span><span class="p">),</span>
                               <span class="n">frozen_docc</span><span class="o">=</span><span class="n">frozen_docc</span><span class="p">,</span>
                               <span class="n">frozen_uocc</span><span class="o">=</span><span class="n">frozen_uocc</span><span class="p">)</span>

<div class="viewcode-block" id="QuantumChemistryPsi4.__init__"><a class="viewcode-back" href="../../../package/quantumchemistry/tequila.quantumchemistry.QuantumChemistryPsi4.html#tequila.quantumchemistry.QuantumChemistryPsi4.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">ParametersQC</span><span class="p">,</span>
                 <span class="n">transformation</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">active_orbitals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters</span>
<span class="sd">        transformation</span>
<span class="sd">        active_orbitals: dictionary :</span>
<span class="sd">            dictionary with irreps as keys and a list of integers as values</span>
<span class="sd">            i.e. occ = {&quot;A1&quot;:[0,1], &quot;A2&quot;:[0]}</span>
<span class="sd">            means the occupied active space is made up of spatial orbitals</span>
<span class="sd">            0A1, 1A1 and 0A2</span>
<span class="sd">            as list: Give a list of spatial orbital indices</span>
<span class="sd">            i.e. occ = [0,1,3] means that spatial orbital 0, 1 and 3 are used</span>
<span class="sd">        reference: (Default value=None)</span>
<span class="sd">            List of orbitals which form the reference</span>
<span class="sd">            Can be given in the same format as active_orbitals</span>
<span class="sd">            If given as None then the first N_electron/2 orbitals are taken</span>
<span class="sd">            and the corresponding active orbitals are removed</span>
<span class="sd">        args</span>
<span class="sd">        kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean_options</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psi4_mol</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_geometry_string</span><span class="p">())</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi4_mol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_point_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi4_mol</span><span class="o">.</span><span class="n">point_group</span><span class="p">()</span><span class="o">.</span><span class="n">symbol</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;point_group&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_point_group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;point_group&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># history to avoid recomputation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># store full psi4 output</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># will be assigned in super</span>
        <span class="c1"># psi4 active space will be formed later</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">transformation</span><span class="o">=</span><span class="n">transformation</span><span class="p">,</span> <span class="n">active_orbitals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">hf_energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irreps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">psi4_mol</span><span class="o">.</span><span class="n">point_group</span><span class="p">()</span><span class="o">.</span><span class="n">char_table</span><span class="p">()</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">symbol</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nirrep</span><span class="p">)]</span>

        <span class="n">oenergies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">irreps</span><span class="p">:</span>
            <span class="n">oenergies</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbital_energies</span><span class="p">(</span><span class="n">irrep</span><span class="o">=</span><span class="n">i</span><span class="p">))]</span>

        <span class="n">oenergies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">oenergies</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">OrbitalData</span><span class="p">(</span><span class="n">irrep</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx_irrep</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">idx_total</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span>
                         <span class="nb">enumerate</span><span class="p">(</span><span class="n">oenergies</span><span class="p">)]</span>
        <span class="n">orbitals_by_irrep</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="o">.</span><span class="n">irrep</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitals</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitals</span><span class="p">:</span>
            <span class="n">orbitals_by_irrep</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">irrep</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">o</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orbitals_by_irrep</span> <span class="o">=</span> <span class="n">orbitals_by_irrep</span>

        <span class="k">if</span> <span class="n">active_orbitals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_psi4_active_space_data</span><span class="p">(</span><span class="n">active_orbitals</span><span class="o">=</span><span class="n">active_orbitals</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span>
            <span class="c1"># need to recompute</span>
            <span class="c1"># (psi4 won&#39;t take over active space information otherwise)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;hf&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s2">&quot;hf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">wfn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_transformation</span><span class="p">(</span><span class="n">transformation</span><span class="o">=</span><span class="n">transformation</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">point_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_point_group</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nirrep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span><span class="o">.</span><span class="n">nirrep</span><span class="p">()</span>

<div class="viewcode-block" id="QuantumChemistryPsi4.orbital_energies"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.orbital_energies.html#tequila.quantumchemistry.QuantumChemistryPsi4.orbital_energies">[docs]</a>    <span class="k">def</span> <span class="nf">orbital_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irrep</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns orbital energies of a given irrep</span>
<span class="sd">        or all orbital energies of all irreps (default)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irrep: int or str :</span>
<span class="sd">            int: specify the irrep by number (in cotton ordering)</span>
<span class="sd">            str: specify the irrep by name (like &#39;A1&#39;)</span>
<span class="sd">            specify from which irrep you want the orbital energies</span>
<span class="sd">            psi4 orders irreps in &#39;Cotton ordering&#39;</span>
<span class="sd">            http://www.psicode.org/psi4manual/master/psithonmol.html#table-irrepordering</span>
<span class="sd">        beta: bool : (Default value=False)</span>
<span class="sd">            get the beta electrons</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or orbital energies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">irrep</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">):</span>
            <span class="n">irrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irreps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">irrep</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">beta</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">p4util</span><span class="o">.</span><span class="n">numpy_helper</span><span class="o">.</span><span class="n">_to_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span><span class="o">.</span><span class="n">epsilon_b</span><span class="p">(),</span> <span class="n">dense</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">p4util</span><span class="o">.</span><span class="n">numpy_helper</span><span class="o">.</span><span class="n">_to_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span><span class="o">.</span><span class="n">epsilon_a</span><span class="p">(),</span> <span class="n">dense</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">irrep</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;c1&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="n">irrep</span><span class="p">]</span></div>

<div class="viewcode-block" id="QuantumChemistryPsi4.make_molecular_hamiltonian"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.make_molecular_hamiltonian.html#tequila.quantumchemistry.QuantumChemistryPsi4.make_molecular_hamiltonian">[docs]</a>    <span class="k">def</span> <span class="nf">make_molecular_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">get_molecular_hamiltonian</span><span class="p">(</span><span class="n">occupied_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">frozen_reference_orbitals</span><span class="p">,</span>
                                                           <span class="n">active_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">active_orbitals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">get_molecular_hamiltonian</span><span class="p">()</span></div>

<div class="viewcode-block" id="QuantumChemistryPsi4.do_make_molecule"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.do_make_molecule.html#tequila.quantumchemistry.QuantumChemistryPsi4.do_make_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">do_make_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MolecularData</span><span class="p">:</span>

        <span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;hf&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wfn</span>

        <span class="n">molecule</span> <span class="o">=</span> <span class="n">MolecularData</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">molecular_data_param</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wfn</span><span class="o">.</span><span class="n">nirrep</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">c1_deep_copy</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">basisset</span><span class="p">())</span>

        <span class="n">molecule</span><span class="o">.</span><span class="n">one_body_integrals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_one_body_integrals</span><span class="p">(</span><span class="n">ref_wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;two_body_ordering&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">two_body_integrals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_two_body_integrals</span><span class="p">(</span><span class="n">ref_wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">two_body_integrals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_two_body_integrals</span><span class="p">(</span><span class="n">ref_wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span>
                                                                          <span class="n">ordering</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;two_body_ordering&quot;</span><span class="p">])</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">hf_energy</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">nuclear_repulsion</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">variables</span><span class="p">()[</span><span class="s1">&#39;NUCLEAR REPULSION ENERGY&#39;</span><span class="p">]</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">canonical_orbitals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">())</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">overlap_integrals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">S</span><span class="p">())</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">n_orbitals</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">canonical_orbitals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">molecule</span><span class="o">.</span><span class="n">n_orbitals</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">orbital_energies</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">epsilon_a</span><span class="p">())</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">fock_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">Fa</span><span class="p">())</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">molecule</span></div>

<div class="viewcode-block" id="QuantumChemistryPsi4.compute_one_body_integrals"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.compute_one_body_integrals.html#tequila.quantumchemistry.QuantumChemistryPsi4.compute_one_body_integrals">[docs]</a>    <span class="k">def</span> <span class="nf">compute_one_body_integrals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_wfn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ref_wfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;hf&quot;</span><span class="p">)</span>
            <span class="n">ref_wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wfn</span>
        <span class="k">if</span> <span class="n">ref_wfn</span><span class="o">.</span><span class="n">nirrep</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">ref_wfn</span><span class="o">.</span><span class="n">c1_deep_copy</span><span class="p">(</span><span class="n">ref_wfn</span><span class="o">.</span><span class="n">basisset</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">ref_wfn</span>
        <span class="n">Ca</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">())</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">H</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xy, yi -&gt; xi&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="s1">&#39;greedy&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xj, xi -&gt; ji&quot;</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="s1">&#39;greedy&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span></div>

<div class="viewcode-block" id="QuantumChemistryPsi4.compute_two_body_integrals"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.compute_two_body_integrals.html#tequila.quantumchemistry.QuantumChemistryPsi4.compute_two_body_integrals">[docs]</a>    <span class="k">def</span> <span class="nf">compute_two_body_integrals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_wfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s1">&#39;openfermion&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ref_wfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;hf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;hf&quot;</span><span class="p">)</span>
            <span class="n">ref_wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s1">&#39;hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wfn</span>

        <span class="k">if</span> <span class="n">ref_wfn</span><span class="o">.</span><span class="n">nirrep</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">ref_wfn</span><span class="o">.</span><span class="n">c1_deep_copy</span><span class="p">(</span><span class="n">ref_wfn</span><span class="o">.</span><span class="n">basisset</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">ref_wfn</span>

        <span class="n">mints</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">basisset</span><span class="p">())</span>

        <span class="c1"># Molecular orbitals (coeffs)</span>
        <span class="n">Ca</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">NBodyTensor</span><span class="p">(</span><span class="n">elems</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mints</span><span class="o">.</span><span class="n">mo_eri</span><span class="p">(</span><span class="n">Ca</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="n">Ca</span><span class="p">)),</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;chem&#39;</span><span class="p">)</span>
        <span class="c1"># Order tensor. default: meet openfermion conventions</span>
        <span class="n">h</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">ordering</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">elems</span></div>

<div class="viewcode-block" id="QuantumChemistryPsi4.compute_ccsd_amplitudes"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.compute_ccsd_amplitudes.html#tequila.quantumchemistry.QuantumChemistryPsi4.compute_ccsd_amplitudes">[docs]</a>    <span class="k">def</span> <span class="nf">compute_ccsd_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the CCSD amplitudes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_amplitudes</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ccsd&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_psi4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">guess_wfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_wfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean_options</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">psi4_representable</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Active space is not Psi4 representable&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;threads&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">nthread</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threads&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">set_output_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># easier guess read in</span>
        <span class="k">if</span> <span class="n">guess_wfn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">guess_wfn</span><span class="p">,</span> <span class="n">QuantumChemistryPsi4</span><span class="p">):</span>
                <span class="n">guess_wfn</span> <span class="o">=</span> <span class="n">guess_wfn</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="s2">&quot;hf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">wfn</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">guess_wfn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">guess_wfn</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">guess_wfn</span><span class="p">)</span>
            <span class="n">guess_wfn</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">guess_wfn</span><span class="o">.</span><span class="n">get_scratch_filename</span><span class="p">(</span><span class="mi">180</span><span class="p">))</span>  <span class="c1"># this is necessary</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;guess&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;read&quot;</span>

        <span class="c1"># prevent known flaws</span>
        <span class="k">if</span> <span class="s2">&quot;guess&quot;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;guess&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;basis_guess&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># additionally the outputfile needs to be the same</span>
            <span class="c1"># as in the previous guess</span>
            <span class="c1"># this can not be determined here</span>
            <span class="c1"># better pass down a guess_wfn</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_geometry_string</span><span class="p">())</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">set_multiplicity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TequilaPsi4Exception</span><span class="p">(</span><span class="s2">&quot;Multiplicity != 1 no yet supported&quot;</span><span class="p">)</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">set_molecular_charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">point_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">reset_point_group</span><span class="p">(</span><span class="n">point_group</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">ref_wfn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ref_wfn&quot;</span><span class="p">):</span>
            <span class="n">ref_wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span>

        <span class="k">if</span> <span class="n">point_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point_group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;c1&quot;</span><span class="p">:</span>
            <span class="n">ref_wfn</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ref_wfn.c1_deep_copy(ref_wfn.basisset())  # CC will not converge otherwise</span>
            <span class="n">guess_wfn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref_wfn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hf&quot;</span><span class="p">:</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">return_wfn</span><span class="o">=</span><span class="n">return_wfn</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">ref_wfn</span><span class="o">=</span><span class="n">ref_wfn</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="n">return_wfn</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span>
                                      <span class="n">guess_wfn</span><span class="o">=</span><span class="n">guess_wfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">Psi4Results</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">variables</span><span class="p">()),</span>
                                                <span class="n">wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">wfn</span>

    <span class="k">def</span> <span class="nf">_extract_active_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arr</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ClosedShellAmplitudes</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_active_space</span><span class="p">(</span><span class="n">arr</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ClosedShellAmplitudes</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
        <span class="n">asd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span>
        <span class="n">aocc</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asd</span><span class="o">.</span><span class="n">active_orbitals</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asd</span><span class="o">.</span><span class="n">reference_orbitals</span><span class="p">]</span>
        <span class="n">avir</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asd</span><span class="o">.</span><span class="n">active_orbitals</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">asd</span><span class="o">.</span><span class="n">reference_orbitals</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_orbitals</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aocc</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">avir</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_electrons</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aocc</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">n_orb_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitals</span><span class="p">)</span>
        <span class="n">n_electrons_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_electrons</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">asd</span><span class="o">.</span><span class="n">frozen_reference_orbitals</span><span class="p">)</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="n">n_electrons_total</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">nvirt</span> <span class="o">=</span> <span class="n">n_orb_total</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">avir</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">nocc</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">avir</span><span class="p">]</span>
        <span class="n">nav</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avir</span><span class="p">)</span>
        <span class="n">nao</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aocc</span><span class="p">)</span>

        <span class="n">arr_shape</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">final_shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">active_sets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">arr_shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nocc</span><span class="p">:</span>
                <span class="n">final_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nao</span><span class="p">)</span>
                <span class="n">active_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aocc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nvirt</span><span class="p">:</span>
                <span class="n">final_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span>
                <span class="n">active_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">nvirt</span>
                <span class="n">final_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nao</span> <span class="o">+</span> <span class="n">nav</span><span class="p">)</span>
                <span class="n">active_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aocc</span> <span class="o">+</span> <span class="n">avir</span><span class="p">)</span>

        <span class="n">final_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">final_shape</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">*=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">active_sets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromfunction</span><span class="p">(</span>
            <span class="n">function</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">arr_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">final_shape</span><span class="p">)</span>

<div class="viewcode-block" id="QuantumChemistryPsi4.compute_mp2_amplitudes"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.compute_mp2_amplitudes.html#tequila.quantumchemistry.QuantumChemistryPsi4.compute_mp2_amplitudes">[docs]</a>    <span class="k">def</span> <span class="nf">compute_mp2_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_orbitals</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClosedShellAmplitudes</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_active_space</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compute_mp2_amplitudes</span><span class="p">())</span></div>

<div class="viewcode-block" id="QuantumChemistryPsi4.compute_amplitudes"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.compute_amplitudes.html#tequila.quantumchemistry.QuantumChemistryPsi4.compute_amplitudes">[docs]</a>    <span class="k">def</span> <span class="nf">compute_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span>
        <span class="n">Amplitudes</span><span class="p">,</span> <span class="n">ClosedShellAmplitudes</span><span class="p">]:</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">basis_set</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mp2&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mp2_amplitudes</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean_options</span><span class="p">()</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_psi4</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                         <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                                         <span class="n">point_group</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span>
                                         <span class="n">ref_wfn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span><span class="o">.</span><span class="n">c1_deep_copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_wfn</span><span class="o">.</span><span class="n">basisset</span><span class="p">()),</span>
                                         <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                                         <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">all_amplitudes</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">get_amplitudes</span><span class="p">()</span>
            <span class="n">closed_shell</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">reference_wavefunction</span><span class="p">(),</span> <span class="n">psi4</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RHF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">closed_shell</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_active_space</span><span class="p">(</span>
                    <span class="n">ClosedShellAmplitudes</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_amplitudes</span><span class="o">.</span><span class="n">items</span><span class="p">()}))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># only for closed-shell currently</span>
                <span class="k">return</span> <span class="n">Amplitudes</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_amplitudes</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TequilaPsi4Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to compute </span><span class="si">{}</span><span class="s2"> amplitudes.</span><span class="se">\n</span><span class="s2">&quot;</span> \
                                       <span class="s2">&quot;Make sure that you don&#39;t read in previous wavefunctions.&quot;</span>
                                       <span class="s2">&quot;Active spaces might get you in trouble.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span></div>

<div class="viewcode-block" id="QuantumChemistryPsi4.compute_energy"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.compute_energy.html#tequila.quantumchemistry.QuantumChemistryPsi4.compute_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fci&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute energy given a method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recompute</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;point_group&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">basis_set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">psi4_representable</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;frozen_docc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">frozen_docc</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">frozen_uocc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hf&quot;</span><span class="p">,</span> <span class="s2">&quot;fci&quot;</span><span class="p">,</span> <span class="s2">&quot;detci&quot;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are known issues with some psi4 methods and frozen virtual orbitals. Proceed with fingers crossed for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;frozen_uocc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">frozen_uocc</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_psi4</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Psi4 Data</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value:15}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Point Group (full)&quot;</span><span class="p">,</span>
                                                    <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psi4_mol</span><span class="o">.</span><span class="n">get_full_point_group</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value:15}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Point Group (used)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">point_group</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;nirrep&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nirrep</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;irreps&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{key:15}</span><span class="s2"> : </span><span class="si">{value:15}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;mos per irrep&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbital_energies</span><span class="p">(</span><span class="n">irrep</span><span class="o">=</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nirrep</span><span class="p">)]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="QuantumChemistryPsi4.prepare_reference"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.prepare_reference.html#tequila.quantumchemistry.QuantumChemistryPsi4.prepare_reference">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prepare_reference</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_qubits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">active_orbitals</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">active_reference_orbitals</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">reference_orbitals</span> <span class="k">if</span>
                                         <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_space</span><span class="o">.</span><span class="n">active_orbitals</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prepare_reference</span><span class="p">(</span><span class="n">reference_orbitals</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_reference_orbitals</span><span class="p">))],</span>
                                             <span class="n">n_qubits</span><span class="o">=</span><span class="n">n_qubits</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rdm1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rdm1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rdm2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rdm2</span>

<div class="viewcode-block" id="QuantumChemistryPsi4.compute_rdms"><a class="viewcode-back" href="../../../package/quantumchemistry/QuantumChemistryPsi4/tequila.quantumchemistry.QuantumChemistryPsi4.compute_rdms.html#tequila.quantumchemistry.QuantumChemistryPsi4.compute_rdms">[docs]</a>    <span class="k">def</span> <span class="nf">compute_rdms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">:</span> <span class="n">QCircuit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">Variables</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spin_free</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">get_rdm1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">get_rdm2</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">psi4_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">psi4_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same functionality as qc_base.compute_rdms (look there for more information),</span>
<span class="sd">        plus the additional option to compute 1- and 2-RDM using psi4 by the keyword psi4_rdms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        U :</span>
<span class="sd">            Quantum Circuit to achieve the desired state :math:`\\psi = U |0\\rangle`, optional if psi4_rdms is set to True</span>
<span class="sd">        variables :</span>
<span class="sd">            If U is parametrized, then need to hand over a set of fixed variables</span>
<span class="sd">        spin_free :</span>
<span class="sd">            Set whether matrices should be spin-free (summation over spin) or defined by spin-orbitals</span>
<span class="sd">        get_rdm1, get_rdm2 :</span>
<span class="sd">            Set whether either one or both rdm1, rdm2 should be computed. If both are needed at some point,</span>
<span class="sd">            it is recommended to compute them at once.</span>
<span class="sd">            Note that whatever is specified in psi4_options has priority.</span>
<span class="sd">        psi4_method:</span>
<span class="sd">            Method to be run, currently only methods returning a CIWavefuntion are supported</span>
<span class="sd">            (e.g. &quot;detci&quot; + ex_level in options, or &quot;fci&quot;, &quot;cisdt&quot;, &quot;casscf&quot;, but NOT &quot;cisd&quot;)</span>
<span class="sd">        psi4_options:</span>
<span class="sd">           Options to be handed over to psi4, containing e.g. excitation level of &quot;detci&quot;-method.</span>
<span class="sd">           If &quot;detci__opdm&quot; for 1-RDM and &quot;detci__tpdm&quot; for 2-RDM are not included, the keywords get_rdm1, get_rdm2 are</span>
<span class="sd">           used (if both are specified, prioritizing psi4_options).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4_method</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compute_rdms</span><span class="p">(</span><span class="n">U</span><span class="o">=</span><span class="n">U</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">spin_free</span><span class="o">=</span><span class="n">spin_free</span><span class="p">,</span>
                                 <span class="n">get_rdm1</span><span class="o">=</span><span class="n">get_rdm1</span><span class="p">,</span> <span class="n">get_rdm2</span><span class="o">=</span><span class="n">get_rdm2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get 1- and 2-particle reduced density matrix via Psi4 CISD computation</span>
            <span class="c1"># If &quot;cisd&quot; is chosen, change to &quot;detci&quot; (default is excitation level 2 anyhow) to obtain a CIWavefunction</span>
            <span class="k">if</span> <span class="n">psi4_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;cisd&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Changed psi4_method from &#39;cisd&#39; to &#39;detci&#39; with ex_level=2 s.th. psi4 returns a CIWavefunction.&quot;</span><span class="p">)</span>
                <span class="n">psi4_method</span> <span class="o">=</span> <span class="s2">&quot;detci&quot;</span>
            <span class="c1"># Set options if not handed over</span>
            <span class="n">psi4_options</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">psi4_options</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>  <span class="c1"># set to lower-case for string comparison</span>
            <span class="k">if</span> <span class="s2">&quot;detci__opdm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psi4_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">psi4_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;detci__opdm&quot;</span><span class="p">:</span> <span class="n">get_rdm1</span><span class="p">})</span>
            <span class="k">if</span> <span class="s2">&quot;detci__tpdm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psi4_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">psi4_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;detci__tpdm&quot;</span><span class="p">:</span> <span class="n">get_rdm2</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">psi4_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;detci&quot;</span> <span class="ow">and</span> <span class="s2">&quot;detci__ex_level&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psi4_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">psi4_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;detci__ex_level&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>  <span class="c1"># use CISD as default</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">psi4_options</span><span class="p">)</span>

            <span class="c1"># Compute and set matrices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_energy</span><span class="p">(</span><span class="n">psi4_method</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">psi4_options</span><span class="p">)</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">[</span><span class="n">psi4_method</span><span class="p">]</span><span class="o">.</span><span class="n">wfn</span>
            <span class="k">if</span> <span class="n">psi4_options</span><span class="p">[</span><span class="s2">&quot;detci__opdm&quot;</span><span class="p">]:</span>
                <span class="n">rdm1</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">p4util</span><span class="o">.</span><span class="n">numpy_helper</span><span class="o">.</span><span class="n">_to_array</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">get_opdm</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;SUM&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">dense</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rdm1</span> <span class="o">=</span> <span class="n">rdm1</span>
            <span class="k">if</span> <span class="n">psi4_options</span><span class="p">[</span><span class="s2">&quot;detci__tpdm&quot;</span><span class="p">]:</span>
                <span class="n">rdm2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">p4util</span><span class="o">.</span><span class="n">numpy_helper</span><span class="o">.</span><span class="n">_to_array</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">get_tpdm</span><span class="p">(</span><span class="s2">&quot;SUM&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">dense</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">rdm2</span> <span class="o">=</span> <span class="n">NBodyTensor</span><span class="p">(</span><span class="n">elems</span><span class="o">=</span><span class="n">rdm2</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;chem&#39;</span><span class="p">)</span>
                <span class="n">rdm2</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="s1">&#39;phys&#39;</span><span class="p">)</span>  <span class="c1"># RDMs in physics ordering (cp. to NBodyTensor in qc_base.py)</span>
                <span class="n">rdm2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">rdm2</span><span class="o">.</span><span class="n">elems</span>  <span class="c1"># Factor 2 since psi4 normalizes 2-rdm by 1/2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rdm2</span> <span class="o">=</span> <span class="n">rdm2</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020, Matter Lab.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>